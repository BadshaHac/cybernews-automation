// Check if articles exist and handle errors
if (!items || !items[0] || !items[0].json || !items[0].json.articles) {
  return [{
    json: {
      newsSummary: 'âŒ **Error**: No articles found or API request failed.',
      error: true
    }
  }];
}

const articles = items[0].json.articles;

// Handle empty results
if (!articles || articles.length === 0) {
  return [{
    json: {
      newsSummary: 'ğŸ“­ **No cybersecurity news found today**\n\nTry again later or check your search criteria.',
      empty: true
    }
  }];
}

// Build the summary header with article count
let summary = `**ğŸ” Daily Cybersecurity News Digest**\n`;
summary += `ğŸ“Š *${articles.length} articles found*\n`;
summary += `ğŸ• *Generated at: ${new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })}*\n\n`;
summary += `---\n\n`;

// Process each article
articles.forEach((article, index) => {
  try {
    // Extract and validate article data
    const title = article.title || 'Untitled Article';
    const url = article.url || '#';
    const source = article.source?.name || 'Unknown Source';
    
    // Format publication date
    const date = article.publishedAt 
      ? new Date(article.publishedAt).toLocaleDateString('en-IN', {
          day: '2-digit', 
          month: 'short', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        })
      : 'Date not available';
    
    // Smart description truncation
    const description = article.description || article.content || '';
    let shortDescription = '';
    
    if (description) {
      // First try to get first 2 sentences
      const sentences = description.match(/[^.!?]+[.!?]+/g) || [];
      if (sentences.length >= 2) {
        shortDescription = sentences.slice(0, 2).join(' ').trim();
      } else {
        shortDescription = description;
      }
      
      // Ensure it's not too long (300 chars max)
      if (shortDescription.length > 300) {
        shortDescription = shortDescription.substring(0, 297) + '...';
      }
      
      // Clean up any HTML tags
      shortDescription = shortDescription.replace(/<[^>]*>/g, '');
    }
    
    // Build article entry
    summary += `**${index + 1}. ${title}**\n`;
    summary += `ğŸ“° *Source: ${source}*\n`;
    summary += `ğŸ“… *Published: ${date}*\n`;
    summary += `ğŸ”— [Read Full Article](${url})\n`;
    
    if (shortDescription) {
      summary += `ğŸ“ ${shortDescription}\n`;
    } else {
      summary += `ğŸ“ *No description available*\n`;
    }
    
    // Add author if available
    if (article.author) {
      summary += `âœï¸ *By: ${article.author}*\n`;
    }
    
    summary += `\n---\n\n`;
    
  } catch (error) {
    // Handle any errors in processing individual articles
    console.error(`Error processing article ${index + 1}:`, error);
    summary += `**${index + 1}. Error processing article**\n\n---\n\n`;
  }
});

// Add footer
summary += `\nğŸ“§ *This digest was automatically generated by the Cybersecurity News Automation system*\n`;
summary += `ğŸ”„ *Next update scheduled for tomorrow at 9:00 AM*`;

// Return the formatted summary
return [{
  json: {
    newsSummary: summary,
    articleCount: articles.length,
    generatedAt: new Date().toISOString()
  }
}];
